---
title: "PNAD Contínua" # Título do relatório
subtitle: "**Primário e Secundário: Ano/Trimestre - RS/BR**"
author: "Fernanda Kelly R. Silva | www.fernandakellyrs.com"
lang: pt 
date: "`r format(Sys.Date())`" 
date-format: short 
toc: true 
format: 
    html: 
      embed-resources: true
      #css: ["custom.css"] 
      code-fold: false 
      code-tools: true  
      theme: 
        light: cosmo
        dark: superhero 
#title-block-banner: "#874a9c" 
code-annotations: hover 
execute:
  warning: false
  message: false
  echo: false
---

```{r}
options(timeout = 600) 
```

```{r}
#| echo: false
#| 
# install.packages("PNADcIBGE")
# install.packages("survey")
library(PNADcIBGE)
library(survey)
library(foreign)
library(srvyr)
library(reactable)
library(purrr)
library(readxl)
```

# Dados

## Trimestre

### Rio Grande do Sul (RS)

```{r}
################################################
# LEITURA DA BASE DE DADOS
################################################

abas <- c(
  "N PRINCIPAL",
  "HABITUAL PRINCIPAL",
  "EFETIVA PRINCIPAL",
  "N SECUNDÁRIO",
  "HABITUAL SECUNDÁRIO",
  "EFETIVA SECUNDÁRIO"
)

tabPSTRI_RS <- map_dfr(
  abas,
  ~ read_excel("Dados/tabPSTRI_RS_4.xlsx", sheet = .x),
  .id = "tipo_principal"
)


################################################
# SOMA DOS IGUAIS
################################################

table_TRIRS_PS <- tabPSTRI_RS %>% 
  dplyr::mutate(Trimestre = dplyr::case_when(Trimestre == "Trimestre_1" ~ "1",
                                             Trimestre == "Trimestre_2" ~ "2",
                                             Trimestre == "Trimestre_3" ~ "3",
                                             Trimestre == "Trimestre_4" ~ "4",
                                             TRUE ~ Trimestre),
                Trimestre = base::factor(Trimestre, levels = c("1", "2", "3", "4")),
                atividade = base::ifelse(is.na(cod_SCN_SEC), cod_SCN_PR, cod_SCN_SEC)) %>% 
  #dplyr::filter(Ano == 2012 & Trimestre == "1") %>% 
  dplyr::group_by(atividade, Ano, Trimestre) %>% 
  dplyr::mutate(soma_N             = base::sum(freq,
                                               na.rm = TRUE),
                qtd_horasHabituais = base::sum(Qtd_horasHabituais,
                                               na.rm = TRUE),
                qtd_horasEfetivas  = base::sum(Qtd_horasEfetivas,
                                               na.rm = TRUE) ) %>% 
  dplyr::select(atividade, Ano, Trimestre, soma_N, qtd_horasHabituais, qtd_horasEfetivas) %>% 
  dplyr::distinct()
  


```

### Brasil (BR)

```{r}
################################################
# LEITURA DA BASE DE DADOS
################################################

abas <- c(
  "N PRINCIPAL",
  "HABITUAL PRINCIPAL",
  "EFETIVA PRINCIPAL",
  "N SECUNDÁRIO",
  "HABITUAL SECUNDÁRIO",
  "EFETIVA SECUNDÁRIO"
)

tabPSTRI_BR <- map_dfr(
  abas,
  ~ read_excel("Dados/tabPSTRI_BR_3.xlsx", sheet = .x),
  .id = "tipo_principal"
)


################################################
# SOMA DOS IGUAIS
################################################

table_TRIBR_PS <- tabPSTRI_BR %>% 
  dplyr::mutate(Trimestre = dplyr::case_when(Trimestre == "Trimestre_1" ~ "1",
                                             Trimestre == "Trimestre_2" ~ "2",
                                             Trimestre == "Trimestre_3" ~ "3",
                                             Trimestre == "Trimestre_4" ~ "4",
                                             TRUE ~ Trimestre),
                Trimestre = base::factor(Trimestre, levels = c("1", "2", "3", "4")),
                atividade = base::ifelse(is.na(cod_SCN_SEC), cod_SCN_PR, cod_SCN_SEC)) %>% 
  #dplyr::filter(Ano == 2012 & Trimestre == "1") %>% 
  dplyr::group_by(atividade, Ano, Trimestre) %>% 
  dplyr::mutate(soma_N             = base::sum(freq,
                                               na.rm = TRUE),
                qtd_horasHabituais = base::sum(Qtd_horasHabituais,
                                               na.rm = TRUE),
                qtd_horasEfetivas  = base::sum(Qtd_horasEfetivas,
                                               na.rm = TRUE) ) %>% 
  dplyr::select(atividade, Ano, Trimestre, soma_N, qtd_horasHabituais, qtd_horasEfetivas) %>% 
  dplyr::distinct()
  


```

## Ano

### Rio Grande do Sul (RS)

```{r}
################################################
# LEITURA DA BASE DE DADOS
################################################

abas <- c(
  "N PRINCIPAL",
  "HABITUAL PRINCIPAL",
  "EFETIVA PRINCIPAL",
  "N SECUNDÁRIO",
  "HABITUAL SECUNDÁRIO",
  "EFETIVA SECUNDÁRIO"
)

tabPSANO_RS <- map_dfr(
  abas,
  ~ read_excel("Dados/tabPSANOS_RS_9.xlsx", sheet = .x),
  .id = "tipo_principal"
)


################################################
# SOMA DOS IGUAIS
################################################

table_ANORS_PS <- tabPSANO_RS %>% 
  dplyr::mutate(Trimestre = dplyr::case_when(Trimestre == "Trimestre_1" ~ "1",
                                             Trimestre == "Trimestre_2" ~ "2",
                                             Trimestre == "Trimestre_3" ~ "3",
                                             Trimestre == "Trimestre_4" ~ "4",
                                             TRUE ~ Trimestre),
                Trimestre = base::factor(Trimestre, levels = c("1", "2", "3", "4")),
                atividade = base::ifelse(is.na(cod_SCN_SEC), cod_SCN_PR, cod_SCN_SEC)) %>% 
  #dplyr::filter(Ano == 2012 & Trimestre == "1") %>% 
  dplyr::group_by(atividade, Ano, Trimestre) %>% 
  dplyr::mutate(soma_N             = base::sum(freq,
                                               na.rm = TRUE),
                qtd_horasHabituais = base::sum(Qtd_horasHabituais,
                                               na.rm = TRUE),
                qtd_horasEfetivas  = base::sum(Qtd_horasEfetivas,
                                               na.rm = TRUE) ) %>% 
  dplyr::select(atividade, Ano, Trimestre, soma_N, qtd_horasHabituais, qtd_horasEfetivas) %>% 
  dplyr::distinct()
  


```

### Brasil (BR)

```{r}
################################################
# LEITURA DA BASE DE DADOS
################################################

abas <- c(
  "N PRINCIPAL",
  "HABITUAL PRINCIPAL",
  "EFETIVA PRINCIPAL",
  "N SECUNDÁRIO",
  "HABITUAL SECUNDÁRIO",
  "EFETIVA SECUNDÁRIO"
)

tabPSANO_BR <- map_dfr(
  abas,
  ~ read_excel("Dados/tabPSANOS_BR_4.xlsx", sheet = .x),
  .id = "tipo_principal"
)


################################################
# SOMA DOS IGUAIS
################################################

table_ANOBR_PS <- tabPSANO_BR %>% 
  dplyr::mutate(Trimestre = dplyr::case_when(Trimestre == "Trimestre_1" ~ "1",
                                             Trimestre == "Trimestre_2" ~ "2",
                                             Trimestre == "Trimestre_3" ~ "3",
                                             Trimestre == "Trimestre_4" ~ "4",
                                             TRUE ~ Trimestre),
                Trimestre = base::factor(Trimestre, levels = c("1", "2", "3", "4")),
                atividade = base::ifelse(is.na(cod_SCN_SEC), cod_SCN_PR, cod_SCN_SEC)) %>% 
  #dplyr::filter(Ano == 2012 & Trimestre == "1") %>% 
  dplyr::group_by(atividade, Ano, Trimestre) %>% 
  dplyr::mutate(soma_N             = base::sum(freq,
                                               na.rm = TRUE),
                qtd_horasHabituais = base::sum(Qtd_horasHabituais,
                                               na.rm = TRUE),
                qtd_horasEfetivas  = base::sum(Qtd_horasEfetivas,
                                               na.rm = TRUE) ) %>% 
  dplyr::select(atividade, Ano, Trimestre, soma_N, qtd_horasHabituais, qtd_horasEfetivas) %>% 
  dplyr::distinct()
  


```

# Excel

```{r}
sheets <- list("N TOTAL PRINCIPAL" = table_1TP,
               "HABITUAL TOTAL"    = table_2TP, 
               "EFETIVA TOTAL"     = table_3TP,
               
               "N TOTAL SECUNDÁRIO" = table_1TS,
               "HABITUAL TOTAL"     = table_2TS, 
               "EFETIVA TOTAL"      = table_3TS,
               
               "N PRINCIPAL"          = table_1P,
               "HABITUAL PRINCIPAL"   = table_2P, 
               "EFETIVA PRINCIPAL"    = table_3P,
               
               "N SECUNDÁRIO"          = table_1S,
               "HABITUAL SECUNDÁRIO"   = table_2S, 
               "EFETIVA SECUNDÁRIO"    = table_3S,
                       
              "N P&S"                          = table_1PS,
              "HABITUAL P&S"                   = table_2PS,
              "EFETIVA P&S"                    = table_3PS)

writexl::write_xlsx(table_RS_PS, 
           paste0("C:/Users/fernanda-romeiro/OneDrive - Governo do Estado do Rio Grande do Sul/Projetos/PNAD/PNAD_projetos/Dados/table_TRIRS_PS.xlsx"))
```
































```{r}

###########################################################
# TESTE DE CÁLCULO DAS HORAS HABITUAIS UTILIZANDO O DUCKDB
###########################################################

library(DBI)
library(duckdb)
library(dplyr)

con <- dbConnect(
  duckdb(),
  dbdir = "dados/pnad.duckdb"
)

env_tmp <- new.env()

load("C:/Users/fernanda-romeiro/OneDrive - Governo do Estado do Rio Grande do Sul/Projetos/PNAD/Dados_completos/Trimestre/dadosPNADc2023_completo.RData", envir = env_tmp)

pnad2023 <- env_tmp$dadosPNADc2023_completo

#criar a tabela no duckdb
dbWriteTable(con, "dadosPNADc2023_completo",
             pnad2023, overwrite = TRUE)

dadosPNADC_2023 <- tbl(con, "dadosPNADc2023_completo") 








##########################################
# DESCONECTAR O DBI
##########################################

dbDisconnect(con, shutdown = TRUE)

```



















